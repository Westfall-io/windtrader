name: Docstring Coverage Badge

on:
  push:
    branches: [main]
    paths:
      - "windseeker/**"
      - "pyproject.toml"
      - "tests/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Compute docstring coverage (interrogate)
        id: cov
        shell: bash
        run: |
          set -euo pipefail

          OUTPUT="$(interrogate -q windseeker || true)"
          echo "$OUTPUT"

          PCT="$(echo "$OUTPUT" | python -c "import sys,re; t=sys.stdin.read(); m=re.search(r'(\d+(?:\.\d+)?)%', t); print(m.group(1) if m else '0')")"
          echo "pct=$PCT" >> "$GITHUB_OUTPUT"

      - name: Write badge JSON
        shell: bash
        env:
          PCT: ${{ steps.cov.outputs.pct }}
        run: |
          set -euo pipefail
          mkdir -p badge
          python -c "import json,os; pct=float(os.environ.get('PCT','0')); \
          color=('brightgreen' if pct>=90 else 'green' if pct>=80 else 'yellowgreen' if pct>=70 else 'yellow' if pct>=60 else 'orange' if pct>=50 else 'red'); \
          data={'schemaVersion':1,'label':'docstrings','message':f'{pct:.1f}%','color':color}; \
          open('badge/docstring-coverage.json','w',encoding='utf-8').write(json.dumps(data))"

      - name: Deploy badge JSON to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: badge
          destination_dir: .
          keep_files: true
